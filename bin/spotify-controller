#!/bin/bash -e

if [ $# -lt 1 ]
then
  echo "No command?"
  exit 1
fi

if [ "$(pidof spotify)" = "" ] 
then
  echo "Spotify is not running"
  exit 2
fi

function trackid {
	trackid=$(dbus-send --print-reply --session --dest=org.mpris.MediaPlayer2.spotify /org/mpris/MediaPlayer2 org.freedesktop.DBus.Properties.Get string:'org.mpris.MediaPlayer2.Player' string:'Metadata'  | grep trackid -A 1 | tail -1 | sed 's/.*".*track:\(.*\)"[^"]*$/\1/')
}

case $1 in
    "play")
        dbus-send --print-reply --dest=org.mpris.MediaPlayer2.spotify /org/mpris/MediaPlayer2 org.mpris.MediaPlayer2.Player.PlayPause
        ;;
    "next")
        dbus-send --print-reply --dest=org.mpris.MediaPlayer2.spotify /org/mpris/MediaPlayer2 org.mpris.MediaPlayer2.Player.Next
        ;;
    "prev")
        dbus-send --print-reply --dest=org.mpris.MediaPlayer2.spotify /org/mpris/MediaPlayer2 org.mpris.MediaPlayer2.Player.Previous
        ;;
   "getStatus")
        dbus-send --print-reply --dest=org.mpris.MediaPlayer2.spotify /org/mpris/MediaPlayer2 org.freedesktop.DBus.Properties.Get string:'org.mpris.MediaPlayer2.Player' string:'PlaybackStatus'|grep 'string "[^"]*"'|sed 's/.*"\(.*\)"[^"]*$/\1/'
        ;;
   "getTrackId")
	trackid
	echo $trackid
	;;
   "getAlbumUrl")
	trackid
	image=$(curl -s https://api.spotify.com/v1/tracks/$trackid | jq '.album.images[0].url' | sed 's/"//g')
	echo $image
	;;
    *)
        echo "Unknown command: " $1
        ;;
esac
